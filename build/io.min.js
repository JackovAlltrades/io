function html(){return arguments[0][0]}class Binding extends Object{constructor(t,e){super(),this.source=t,this.sourceProp=e,this.targets=[],this.targetsMap=new WeakMap,this.updateSource=this.updateSource.bind(this),this.updateTarget=this.updateTarget.bind(this)}clone(){return new Binding(this.source,this.sourceProp)}setTarget(t,e){if(this.targets.indexOf(t)===-1&&this.targets.push(t),this.targetsMap.has(t)){let i=this.targetsMap.get(t);i.indexOf(e)===-1&&i.push(e)}else this.targetsMap.set(t,[e])}purgeTargets(){for(let t=this.targets.length;t--;)this.targetsMap.delete(this.targets[t]);this.targets.length=0}updateSource(t){this.targets.indexOf(t.srcElement)!==-1&&this.source[this.sourceProp]!==t.detail.value&&(this.source[this.sourceProp]=t.detail.value)}updateTarget(t){if(t.srcElement==this.source)for(let e=this.targets.length;e--;){let i=this.targetsMap.get(this.targets[e]);for(let s=i.length;s--;)this.targets[e][i[s]]!==t.detail.value&&(this.targets[e][i[s]]=t.detail.value)}}bind(){this.source.__properties[this.sourceProp].notify=!0,this.source.addEventListener(this.sourceProp+"-changed",this.updateTarget);for(let t=this.targets.length;t--;){let e=this.targetsMap.get(this.targets[t]);for(let i=e.length;i--;)this.targets[t].__properties[e[i]].notify=!0,this.targets[t].addEventListener(e[i]+"-changed",this.updateSource),this.targets[t][e[i]]=this.source[this.sourceProp]}return this}unbind(){this.source&&this.source.removeEventListener(this.sourceProp+"-changed",this.updateTarget);for(let t=this.targets.length;t--;){let e=this.targetsMap.get(this.targets[t]);for(let i=e.length;i--;)this.targets[t]&&this.targets[t].removeEventListener(e[i]+"-changed",this.updateSource)}return this}}const IoBindingMixin=t=>class extends t{bind(t){return this.__bindings[t]=this.__bindings[t]||new Binding(this,t),this.__bindings[t]}unbind(t){this.__bindings[t]&&this.__bindings[t][i].unbind(),delete this.__bindings[t]}unbindAll(){for(let t in this.__bindings)this.unbind(t)}},IoPropertyMixin=t=>class extends t{static get properties(){return{value:{type:Object,observer:"update"},key:{type:String,observer:"update"}}}constructor(t){super(t),this.setProperty=this.setProperty.bind(this)}connectedCallback(){super.connectedCallback(),window.addEventListener("io-object-mutated",this._objectMutatedHandler)}disconnectedCallback(){super.disconnectedCallback(),window.removeEventListener("io-object-mutated",this._objectMutatedHandler)}_objectMutatedHandler(t){t.detail.object===this.value&&(t.detail.key!==this.key&&"*"!==t.detail.key&&"*"!==this.key||this.update())}setProperty(t){this.value[this.key]=t.detail.value,window.dispatchEvent(new CustomEvent("io-object-mutated",{detail:{object:this.value,key:this.key},bubbles:!1,composed:!0}))}},_clickmask=document.createElement("div");_clickmask.style="position: fixed; top:0; left:0; bottom:0; right:0; z-index:2147483647;";class Vector2 extends Object{constructor(t={}){super(),this.x=t.x||0,this.y=t.y||0}set(t){return this.x=t.x,this.y=t.y,this}sub(t){return this.x-=t.x,this.y-=t.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}distanceTo(t){let e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)}getClosest(t){let e=t[0];for(let i=1;i<t.length;i++)this.distanceTo(t[i])<this.distanceTo(e)&&(e=t[i]);return e}}class Pointer extends Object{constructor(t={}){super(),this.position=new Vector2(t.position),this.previous=new Vector2(t.previous),this.movement=new Vector2(t.movement),this.distance=new Vector2(t.distance),this.start=new Vector2(t.start)}getClosest(t){let e=t[0];for(let i=1;i<t.length;i++)this.position.distanceTo(t[i].position)<this.position.distanceTo(e.position)&&(e=t[i]);return e}update(t){this.previous.set(this.position),this.movement.set(t.position).sub(this.position),this.distance.set(t.position).sub(this.start),this.position.set(t.position)}}const IoPointerMixin=t=>class extends t{static get properties(){return{pointers:{value:[],type:Array},listeners:{mousedown:"_mousedownHandler",touchstart:"_touchstartHandler",mousemove:"_mousehoverHandler"}}}constructor(t){super(t),this._clickmask=_clickmask}getPointers(t,e){let i=t.touches?t.touches:[t],s=[],n=this.getBoundingClientRect();for(var r=0;r<i.length;r++)if(i[r].target===t.target||void 0===t.touches){let t=new Vector2({x:i[r].clientX-n.left,y:i[r].clientY-n.top});void 0===this.pointers[r]&&(this.pointers[r]=new Pointer({start:t}));let o=new Pointer({position:t}),h=o.getClosest(this.pointers);e&&h.start.set(t),h.update(o),s.push(h)}for(r=this.pointers.length;r--;)s.indexOf(this.pointers[r])===-1&&this.pointers.splice(r,1)}_mousedownHandler(t){t.preventDefault(),this.focus(),this.getPointers(t,!0),this._fire("io-pointer-start",t,this.pointers),window.addEventListener("mousemove",this._mousemoveHandler),window.addEventListener("mouseup",this._mouseupHandler),_clickmask.parentNode!==document.body&&document.body.appendChild(_clickmask)}_mousemoveHandler(t){this.getPointers(t),this._fire("io-pointer-move",t,this.pointers)}_mouseupHandler(t){this.getPointers(t),this._fire("io-pointer-end",t,this.pointers),window.removeEventListener("mousemove",this._mousemoveHandler),window.removeEventListener("mouseup",this._mouseupHandler),_clickmask.parentNode===document.body&&document.body.removeChild(_clickmask)}_mousehoverHandler(t){this.getPointers(t),this._fire("io-pointer-hover",t,this.pointers)}_touchstartHandler(t){t.preventDefault(),this.focus(),this.getPointers(t,!0),this._fire("io-pointer-hover",t,this.pointers),this._fire("io-pointer-start",t,this.pointers),this.addEventListener("touchmove",this._touchmoveHandler),this.addEventListener("touchend",this._touchendHandler)}_touchmoveHandler(t){t.preventDefault(),this.getPointers(t),this._fire("io-pointer-move",t,this.pointers)}_touchendHandler(t){t.preventDefault(),this.removeEventListener("touchmove",this._touchmoveHandler),this.removeEventListener("touchend",this._touchendHandler),this._fire("io-pointer-end",t,this.pointers)}_fire(t,e,i){this.fire(t,{event:e,pointer:i},!1)}};class Io extends IoBindingMixin(HTMLElement){static get style(){return html``}static get definedProperties(){let t={properties:{},attributes:{},listeners:{}},e=this;for(;e;){let i=e.properties;for(let e in i)if("listeners"===e)for(let s in i[e])t.listeners[s]=t.listeners[s]||[],t.listeners[s].push(i[e][s]);else if("attributes"===e)for(let s in i[e])t.attributes[s]=i[e][s];else void 0===i[e].value&&(i[e].type===Boolean&&(i[e].value=!1),i[e].type===Number&&(i[e].value=0),i[e].type===String&&(i[e].value="")),i[e].notify=i[e].notify||!1,i[e].bubbles=i[e].bubbles||!1,t.properties[e]=Object.assign(i[e],t.properties[e]||{});e=e.__proto__}return t}static get definedHandlers(){let t=[],e=this.prototype;for(;e;){let i=Object.getOwnPropertyNames(e);for(let e=0;e<i.length;e++)"Handler"===i[e].substring(i[e].length-7,i[e].length)&&t.push(i[e]);e=e.__proto__}return t}constructor(t={}){super(),initStyle(this.localName,this.__proto__.constructor.style);let e=this.__proto__.constructor.definedProperties;Object.defineProperty(this,"__properties",{value:e.properties}),Object.defineProperty(this,"__attributes",{value:e.attributes}),Object.defineProperty(this,"__listeners",{value:e.listeners}),Object.defineProperty(this,"__handlers",{value:this.__proto__.constructor.definedHandlers}),Object.defineProperty(this,"__bindings",{value:{}});for(let e in this.__properties){if(t[e]instanceof Binding){let i=t[e];this.__properties[e].value=i.source[i.sourceProp],i.setTarget(this,e),i.bind()}else void 0!==t[e]&&(this.__properties[e].value=t[e]);this.defineProperty(e,this.__properties[e]),this.reflectAttribute(e,this.__properties[e])}for(let t in this.__attributes)this.setAttribute(t,this.__attributes[t]);for(let t=0;t<this.__handlers.length;t++)this[this.__handlers[t]]=this[this.__handlers[t]].bind(this)}connectedCallback(){for(let t in this.__listeners)for(let e=0;e<this.__listeners[t].length;e++)"string"==typeof this.__listeners[t][e]&&(this.__listeners[t][e]=this[this.__listeners[t][e]]),this.addEventListener(t,this.__listeners[t][e]);this.update()}disconnectedCallback(){for(let t in this.__listeners)for(let e=0;e<this.__listeners[t].length;e++)this.removeEventListener(t,this.__listeners[t][e])}defineProperty(t,e){Object.defineProperty(this,t,{get:function(){return e.value},set:function(i){if(e.value!==i){let s=e.value;e.value=i,this.reflectAttribute(t,e),e.observer&&this[e.observer](i,s,t),e.notify&&this.fire(t+"-changed",{value:i,oldValue:s},e.bubbles)}},enumerable:!0,configurable:!0})}reflectAttribute(t,e){e.reflectToAttribute&&(e.value===!0?this.setAttribute(t,""):e.value===!1||""===e.value?this.removeAttribute(t):"string"!=typeof e.value&&"number"!=typeof e.value||this.setAttribute(t,e.value))}render(t,e){this.traverse(buildVDOM()(["root",t]).children,e||this)}traverse(t,e){let i=e.children;for(;i.length>t.length;)e.removeChild(i[i.length-1]);let s=document.createDocumentFragment();for(let e=i.length;e<t.length;e++)s.appendChild(_renderElement(t[e]));e.appendChild(s);for(let s=0;s<i.length;s++){let r,o,h=[],u=[];if(i[s].localName===t[s].name){r=i[s];for(let e in t[s].props)if(t[s].props[e]!==r[e]){if("style"===e||"listeners"===e||"class"===e)continue;let i=t[s].props[e];if(i instanceof Binding){let t=i;i=t.source[t.sourceProp],t.setTarget(r,e),t.bind()}if(r.__properties&&r.__properties.hasOwnProperty(e)){let t=r.__properties[e].value;r.__properties[e].value=i,r.__properties[e].reflectToAttribute&&u.indexOf(e)===-1&&u.push(e),r.__properties[e].observer&&h.indexOf(r.__properties[e].observer)===-1&&i!==t&&h.push(r.__properties[e].observer)}else r[e]=i}for(var n=0;n<h.length;n++)r[h[n]]();for(var n=0;n<u.length;n++)r.reflectAttribute(u[n],r.__properties[u[n]])}else o=i[s],e.insertBefore(_renderElement(t[s]),o),e.removeChild(o)}for(let e=0;e<i.length;e++){let s=i[e];for(let i in t[e].props)if("listeners"==i)for(let n in t[e].props[i])"function"==typeof t[e].props[i][n]&&(s.__listeners[n]=s.__listeners[n]||[],s.__listeners[n].push(t[e].props[i][n]),s.addEventListener(n,t[e].props[i][n]));else if("style"==i)for(let n in t[e].props[i])s.style[n]=t[e].props[i][n];else"class"==i&&(s.className=t[e].props[i]);t[e].children&&"string"==typeof t[e].children?s.innerHTML=t[e].children:t[e].children&&"object"==typeof t[e].children&&this.traverse(t[e].children,s)}}update(){}set(t,e){let i=this[t];this[t]=e,this.fire(t+"-set",{value:e,oldValue:i},!1)}fire(t,e,i=!0){this.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:i,composed:!0}))}}const _renderElement=function(t){let e,i=customElements.get(t.name);if(i)e=new i(t.props);else{e=document.createElement(t.name);for(let i in t.props)e[i]=t.props[i]}return e},_styledElements={},_stagingElement=document.createElement("div"),initStyle=function(t,e){if(e&&!_styledElements[t]){_styledElements[t]=!0,_stagingElement.innerHTML=e.replace(new RegExp(":host","g"),t);let i=_stagingElement.querySelector("style");i.setAttribute("id","io-style-"+t),document.head.appendChild(i)}},clense=(t,e)=>e?"string"==typeof e[0]?[...t,e]:[...t,...e]:t,buildVDOM=()=>t=>t&&"object"==typeof t[1]&&!Array.isArray(t[1])?{["name"]:t[0],["props"]:t[1],["children"]:Array.isArray(t[2])?t[2].reduce(clense,[]).map(buildVDOM()):t[2]||""}:buildVDOM()([t[0],{},t[1]||""]);export{IoPropertyMixin:IoPropertyMixin,IoPointerMixin:IoPointerMixin,html:html,Io:Io};
