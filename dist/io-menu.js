import{IoThemeSingleton,IoLayerSingleton,IoItem}from"./io-core.js";import{IoElement,html}from"./io.js";const rects=new WeakMap;class IoMenuOptions extends IoElement{static get Style(){return html`<style>:host {${IoThemeSingleton.panel}}:host {align-self: flex-start;display: flex;flex-direction: column;align-items: stretch;white-space: nowrap;user-select: none;background-image: none;padding: 0;}:host:not([horizontal]) {padding: var(--io-spacing) 0;}:host[inlayer]:not([expanded]) {visibility: hidden;}:host[horizontal] {flex-direction: row;align-self: stretch;justify-self: stretch;flex-wrap: nowrap;}:host[horizontal] > * {border-left-width: 0;border-right-width: 0;padding: var(--io-spacing) calc(0.5 * var(--io-line-height));}:host:not([horizontal]) > io-menu-item > * {min-width: 0.5em;padding: 0 var(--io-spacing);}:host[horizontal] > io-menu-item > .io-menu-hint,:host[horizontal] > io-menu-item > .io-menu-more {display: none;}:host[horizontal] > io-menu-item.io-hamburger {margin-left: auto;}:host[horizontal] > io-menu-item.io-hamburger[hidden] {display: inline-block;width: 0;padding: 0;border: 0;overflow: hidden;visibility: hidden;}</style>`}static get Properties(){return{value:{value:null,notify:!0},options:Array,expanded:{value:!1,reflect:1},horizontal:{type:Boolean,reflect:1},position:"right",selectable:!1,overflow:{type:Boolean,reflect:1},slotted:Array,$parent:HTMLElement,_rects:Array,role:"listbox"}}static get Listeners(){return{"item-clicked":"_onMenuItemClicked"}}connectedCallback(){super.connectedCallback(),this.setAttribute("inlayer",this.parentElement===IoLayerSingleton)}_onMenuItemClicked(e){e.composedPath()[0]!==this&&(e.stopImmediatePropagation(),this.set("value",e.detail.value),this.dispatchEvent("item-clicked",e.detail,!0),this.expanded=!1)}onResized(){this.setOverflow()}setOverflow(){const e=this.querySelectorAll("io-menu-item:not(.io-hamburger)");if(this.horizontal){const t=this.querySelector(".io-hamburger");if(!e.length)return;let i=this.getBoundingClientRect().right,n=!1,o=1/0;t.hidden=!0;const s=[];for(let r=e.length;r--;){const a=e[r].getBoundingClientRect(),l=rects.get(e[r])||{right:0,width:0};0!==a.right&&0!==a.width&&(l.right=a.right,l.width=a.width,rects.set(e[r],l)),t.hidden&&n&&(t.hidden=!1,i-=t.getBoundingClientRect().width),e[r].selected?(i-=l.width,e[r].hidden=!1):(o=Math.min(o,l.right))<i?e[r].hidden=!1:(e[r].hidden=!0,s.push(e[r].option),n=!0)}t.option={options:s},this.overflow=n}else for(let t=e.length;t--;)e[t].hidden=!1}expandedChanged(){if(this.parentElement===IoLayerSingleton&&this.expanded&&this.$parent){let e=this.getBoundingClientRect(),t=this.$parent.getBoundingClientRect();const i=IoLayerSingleton._x,n=IoLayerSingleton._y;switch(this.position){case"pointer":IoLayerSingleton.nudgePointer(this,i,n,e);break;default:IoLayerSingleton.setElementPosition(this,this.position,t)}}}changed(){const e=this.horizontal?"bottom":"right",t=[];this.options&&t.push(...[this.options.map(t=>["io-menu-item",{$parent:this,option:t,value:this.value,direction:e,selectable:this.selectable}])]),this.horizontal&&(t.splice(0,0,...this.slotted),t.push(["io-menu-item",{label:"☰",title:"select tab",value:this.value,selectable:this.selectable,class:"io-hamburger"}])),this.template(t),this.setOverflow(),this.setOverflow()}}function filterObject(e,t){if(t(e))return e;for(let i in e){if(t(e[i]))return e[i];if("object"==typeof e[i]){const n=filterObject(e[i],t);if(n)return n}}}function getElementDescendants(e){const t=[];let i;-1!=="io-menu-item, io-option-menu".search(e.localName)?(t.push(e),i=e.$options.querySelectorAll("io-menu-item, io-option-menu")):i="io-context-menu"===e.localName?e.$options.querySelectorAll("io-menu-item, io-option-menu"):e.querySelectorAll("io-menu-item, io-option-menu");for(let e=i.length;e--;)t.push(i[e]),i[e].expanded&&t.push(...getElementDescendants(i[e]));return t}function getElementAncestors(e){let t=e;const i=[e];for(;t&&t.$parent;)(t=t.$parent)&&i.push(t);return i}function getRootElement(e){let t=e;for(;t&&t.$parent;)t=t.$parent;return t}function isPointerAboveElement(e,t){const i=t.getBoundingClientRect(),n=e.clientX,o=e.clientY;return!(i.top<0||i.bottom>window.innerHeight||i.left<0||i.right>window.innerWidth)&&(i.top<o&&i.bottom>o&&i.left<n&&i.right>n)}IoMenuOptions.Register();class IoMenuItem extends IoItem{static get Style(){return html`<style>:host {display: flex;flex: 0 0 auto;flex-direction: row;padding: var(--io-spacing);border-radius: 0;background: none;border: var(--io-border-width) solid transparent;}:host:hover:not([selected]) {background-color: inherit;}:host > * {overflow: visible;pointer-events: none;}:host > :not(:empty) {padding: 0 var(--io-spacing);}:host > .io-menu-icon {}:host > .io-menu-label {flex: 1 1 auto;text-overflow: ellipsis;}:host > .io-menu-hint {opacity: 0.25;}:host[hasmore]:after {content: '▸';}:host[selected][direction="top"],:host[selected][direction="bottom"] {border-bottom-color: var(--io-color-link);}:host[selected][direction="right"],:host[selected][direction="left"] {border-left-color: var(--io-color-link);}</style>`}static get Properties(){return{option:Object,expanded:{value:!1,reflect:1},direction:{value:"bottom",reflect:1},$parent:HTMLElement,$options:HTMLElement,selectable:!1}}static get Listeners(){return{click:"_preventDefault"}}_preventDefault(e){e.stopPropagation(),e.preventDefault()}constructor(e){super(e),this.$options=new IoMenuOptions({$parent:this,expanded:this.bind("expanded"),"on-item-clicked":this._onOptionItemClicked,"on-expanded-changed":IoLayerSingleton.onChildExpanded}),Object.defineProperty(this,"_v",{value:0,writable:!0}),Object.defineProperty(this,"_p",{value:null,writable:!0})}get _options(){if(this.option&&this.option.options&&this.option.options.length)return this.option.options}get _action(){if(this.option&&"function"==typeof this.option.action)return this.option.action}get _value(){return this.option&&void 0!==this.option.value?this.option.value:void 0!==this.option&&"object"!=typeof this.option?this.option:void 0}get _icon(){if(this.option&&void 0!==this.option.icon)return this.option.icon}get _label(){return this.label?this.label:this.option&&void 0!==this.option.label?this.option.label:this.option&&void 0!==this.option.value?String(this.option.value):String(this.option)}get _hint(){if(this.option&&void 0!==this.option.hint)return this.option.hint}get _selected(){if(!this.selectable)return!1;if(this.option&&(this.option.selected||this.option.value===this.value))return!0;if(this.value===this.option)return!0;const e=this._options;return!!e&&!!filterObject(e,e=>e===this.value||e.value===this.value)}get _inLayer(){return this.$parent&&this.$parent.parentElement===IoLayerSingleton}connectedCallback(){super.connectedCallback(),IoLayerSingleton.appendChild(this.$options),this._inLayer||IoLayerSingleton.addEventListener("pointermove",this._onLayerPointermove)}disconnectedCallback(){super.disconnectedCallback(),IoLayerSingleton.removeChild(this.$options),IoLayerSingleton.removeEventListener("pointermove",this._onLayerPointermove)}_onClick(e){"click"!==e.type?void 0!==this._value||this._action?(void 0!==this._value&&this.set("value",this._value,!0),this._action&&this._action.apply(null,[this._value]),this.dispatchEvent("item-clicked",{value:this._value,action:this._action},!0),getRootElement(this).expanded=!1):this._options&&(this.expanded=!0):console.log("asd")}_onPointerdown(e){e.stopPropagation(),this.addEventListener("pointermove",this._onPointermove),this.addEventListener("pointerup",this._onPointerup),this.setPointerCapture(e.pointerId),(this.expanded||"mouse"===e.pointerType||this._inLayer)&&(this.focus(),this._options&&(this.expanded=!0)),this._v=0,this._p=this.parentElement}_getHoveredItem(e){const t=getElementDescendants(getRootElement(this));let i;for(let n=t.length;n--;)isPointerAboveElement(e,t[n])&&(i=t[n]);return i}_onPointermove(e){if(!this.expanded&&"touch"===e.pointerType&&!this._inLayer)return;IoLayerSingleton._x=e.clientX,IoLayerSingleton._y=e.clientY,clearTimeout(this.__timeoutOpen),this._v=(2*this._v+Math.abs(e.movementY)-Math.abs(e.movementX))/3;let t=this._getHoveredItem(e);if(t){const e=100;if(this._p!==t.parentElement){this._p=t.parentElement,t.focus(),t._options&&(t.expanded=!0);const e=getElementDescendants(t.$options);for(let t=e.length;t--;)e[t].expanded=!1}else this._v>.5?(t.focus(),t._options&&(t.expanded=!0)):this.__timeoutOpen=setTimeout(()=>{t.focus(),t._options&&(t.expanded=!0)},e)}}_onLayerPointermove(e){this.expanded&&this._onPointermove(e)}_onPointerup(e){this.removeEventListener("pointermove",this._onPointermove),this.removeEventListener("pointerup",this._onPointerup),this.pressed=!1;let t=this._getHoveredItem(e);t?t._onClick(e):this.expanded=!1}_onKeydown(e){if("Enter"===e.key||" "===e.key)return this.pressed=!0,e.preventDefault(),this.expanded?void(this.expanded=!1):void this._onClick(e);if("Escape"===e.key)return e.preventDefault(),void(getRootElement(this).expanded=!1);let t="";"left"===this.direction||"right"===this.direction?("ArrowUp"===e.key&&(t="prev"),"ArrowRight"===e.key&&(t="in"),"ArrowDown"===e.key&&(t="next"),"ArrowLeft"===e.key&&(t="out")):("ArrowUp"===e.key&&(t="out"),"ArrowRight"===e.key&&(t="next"),"ArrowDown"===e.key&&(t="in"),"ArrowLeft"===e.key&&(t="prev")),this._inLayer&&"Tab"===e.key&&(t="next");const i=this.$parent?[...this.$parent.children]:[],n=i.indexOf(this);if(t&&(this._inLayer||this.expanded))switch(e.preventDefault(),t){case"prev":{const e=i[(n+i.length-1)%i.length];this.expanded=!1,e&&(e._options&&(e.expanded=!0),e.focus());break}case"next":{const e=i[(n+1)%i.length];this.expanded=!1,e&&(e._options&&(e.expanded=!0),e.focus());break}case"in":this.$options.children.length&&this.$options.children[0].focus();break;case"out":this.expanded=!1,this.$parent&&this.$parent.$parent&&this.$parent.$parent.focus()}else this.expanded=!1,super._onKeydown(e)}_onOptionItemClicked(e){e.composedPath()[0]!==this&&(e.stopImmediatePropagation(),this.set("value",e.detail.value),this.dispatchEvent("item-clicked",e.detail,!0))}expandedChanged(){if(this.expanded){const e=getElementDescendants(getRootElement(this)),t=getElementAncestors(this);for(let i=e.length;i--;)-1===t.indexOf(e[i])&&(e[i].expanded=!1);const i=getElementDescendants(this.$options);for(let e=i.length;e--;)i[e].expanded=!1}else{const e=getElementDescendants(this);for(let t=e.length;t--;)e[t].expanded=!1}}changed(){this.__properties.selected.value=this._selected,this.setAttribute("selected",this._selected),this.setAttribute("hasmore",this._options&&"right"===this.direction),this.template([["span",{class:"io-menu-icon"},this._icon],["span",{class:"io-menu-label"},this._label||String(this._value)],["span",{class:"io-menu-hint"},this._hint]]),this.$options.setProperties({value:this.value,options:this._options,selectable:this.selectable,position:this.direction})}}IoMenuItem.Register();class IoOptionMenu extends IoMenuItem{static get Style(){return html`<style>:host {display: inline-block;text-align: center;border-radius: var(--io-border-radius);border: var(--io-border);border-color: var(--io-color-border-outset);background-color: var(--io-background-color-dark);background-image: var(--io-gradient-button);padding-left: calc(2 * var(--io-spacing));padding-right: calc(2 * var(--io-spacing));}:host {text-align: left;}</style>`}static get Properties(){return{value:{reflect:-1},selectable:!0,options:{type:Array,reflect:-1},role:"button"}}get _options(){if(this.options&&this.options.length)return this.options}changed(){let e;if(this.options){const t=this.options.find(e=>e.value===this.value);t&&(e=t.label?t.label:"object"==typeof t.value?`${t.value.constructor.name}`+(t.value instanceof Array?`(${t.value.length})`:""):String(t.value))}e=this.label||(e||String(this.value))+" ▾",this.textNode=e,this.title=e,this.setAttribute("aria-haspopup","listbox"),this.setAttribute("aria-expanded",String(this.expanded)),this.$options.setProperties({value:this.value,options:this._options,selectable:this.selectable,position:this.direction})}}IoOptionMenu.Register();class IoContextMenu extends IoElement{static get Properties(){return{value:null,options:Array,expanded:Boolean,position:"pointer",button:0,selectable:!1,$options:IoMenuOptions}}get compose(){return{$options:{$parent:this,value:this.bind("value"),expanded:this.bind("expanded"),selectable:this.bind("selectable"),options:this.options,position:this.position,"on-io-menu-item-clicked":this._onOptionItemClicked,"on-expanded-changed":IoLayerSingleton.onChildExpanded}}}connectedCallback(){super.connectedCallback(),IoLayerSingleton.appendChild(this.$options),IoLayerSingleton.addEventListener("pointermove",this._onLayerPointermove),this._parent=this.parentElement,this._parent.style.userSelect="none",this._parent.addEventListener("contextmenu",this._onContextmenu),this._parent.addEventListener("pointerdown",this._onPointerdown),this._parent.addEventListener("click",this._onClick)}disconnectedCallback(){super.disconnectedCallback(),IoLayerSingleton.removeChild(this.$options),IoLayerSingleton.removeEventListener("pointermove",this._onLayerPointermove),this._parent.style.userSelect=null,this._parent.removeEventListener("contextmenu",this._onContextmenu),this._parent.removeEventListener("pointerdown",this._onPointerdown),this._parent.removeEventListener("click",this._onClick)}getBoundingClientRect(){return this._parent.getBoundingClientRect()}_onOptionItemClicked(e){e.composedPath()[0]!==this&&(e.stopPropagation(),this.set("value",e.detail.value),this.dispatchEvent("item-clicked",e.detail,!0),this.expanded=!1)}_onContextmenu(e){2===this.button&&(e.preventDefault(),this.expand(e))}_onPointerdown(e){"mouse"===e.pointerType&&e.button===this.button&&2!==e.button&&(this._parent.setPointerCapture(e.pointerId),this._parent.addEventListener("pointermove",this._onPointermove),this._parent.addEventListener("pointerup",this._onPointerup),this.expand(e))}_onPointermove(e){if(this.expanded){const t=this.$options.querySelector("io-menu-item");t&&t._onPointermove(e)}}_onPointerup(){if(this.expanded){const e=this.$options.querySelector("io-menu-item");e&&e._onPointerup(event)}this._parent.releasePointerCapture(event.pointerId),this._parent.removeEventListener("pointermove",this._onPointermove),this._parent.removeEventListener("pointerup",this._onPointerup)}_onLayerPointermove(e){this.expanded&&this._onPointermove(e)}_onClick(e){e.button===this.button&&2!==e.button&&this.expand(e)}expand(e){!this.expanded&&this.options.length&&(IoLayerSingleton._x=e.clientX,IoLayerSingleton._y=e.clientY,this.expanded=!0)}}IoContextMenu.Register();export{IoContextMenu,IoMenuItem,IoMenuOptions,IoOptionMenu};